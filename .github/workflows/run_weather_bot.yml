name: Weather Bot

on:
  schedule:
    # Run daily at 8:00 AM UTC
    - cron: '0 8 * * *'
  workflow_dispatch:

jobs:
  run_weather_bot:
    runs-on: ubuntu-latest
    environment: production  # Use environment for secrets
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        
    - name: Create OAuth files from secrets
      run: |
        echo "Creating OAuth files from secrets..."
        # CLIENT_SECRETS_JSON should contain the full JSON of your client_secrets.json
        echo '${{ secrets.CLIENT_SECRETS_JSON }}' > client_secrets.json
        # TOKEN_JSON should contain the full JSON of your token.json (from a working local run)
        echo '${{ secrets.TOKEN_JSON }}' > token.json
        echo "OAuth files created successfully."
        
    - name: Run the weather bot
      env:
        # API Keys
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        BLOGGER_API_KEY: ${{ secrets.BLOGGER_API_KEY }}
        
        # Blogger Configuration
        BLOG_ID: ${{ secrets.BLOG_ID }}
        BLOG_BASE_URL: ${{ secrets.BLOG_BASE_URL }}
        
        # OAuth Configuration
        CLIENT_SECRETS_FILE: client_secrets.json
        
        # Publishing Configuration
        PUBLISH: ${{ secrets.PUBLISH }}
        
        # NWS Configuration
        NWS_USER_AGENT: ${{ secrets.NWS_USER_AGENT }}
      run: python -m src.main
      
    - name: Upload generated posts
      uses: actions/upload-artifact@v4
      with:
        name: generated-posts
        path: output_posts
        if-no-files-found: warn