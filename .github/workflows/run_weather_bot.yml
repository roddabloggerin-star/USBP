name: run_weather_bot

on:
  # Run every 2 hours (GitHub scheduled times are in UTC)
  schedule:
    - cron: "0 */2 * * *"
  # Allow manual runs for testing
  workflow_dispatch:

jobs:
  run_weather_bot:
    runs-on: ubuntu-latest

    env:
      # Secrets (all stored in GitHub repo settings â†’ Secrets and variables â†’ Actions)
      NWS_USER_AGENT: ${{ secrets.NWS_USER_AGENT }}
      BLOG_ID: ${{ secrets.BLOG_ID }}               # required only when PUBLISH=true
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      BLOGGER_API_KEY: ${{ secrets.BLOGGER_API_KEY }} # if you still use it in api_client
      BLOG_BASE_URL: ${{ secrets.BLOG_BASE_URL }}     # e.g. https://usa-weather-updates.blogspot.com

      # File paths used by the code
      CLIENT_SECRETS_FILE: client_secrets.json
      STATE_FILE: last_posted_zone.txt

      # MASTER SWITCH: set this secret to "false" for testing; "true" for real publishing
      PUBLISH: ${{ secrets.PUBLISH }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      # ðŸŒŸ CHANGE 1: Explicitly install ALL required dependencies, including aiohttp
      - name: Install dependencies
        run: |
          # The new main.py uses aiohttp for high-performance concurrent API calls.
          # We ensure all necessary libraries are installed here for a robust environment.
          pip install google-genai python-dotenv google-auth google-auth-oauthlib google-api-python-client requests aiohttp

      - name: Create OAuth files from secrets
        run: |
          echo "Creating OAuth files from secrets..."
          # CLIENT_SECRETS_JSON should contain the full JSON of your client_secrets.json
          echo '${{ secrets.CLIENT_SECRETS_JSON }}' > client_secrets.json
          # TOKEN_JSON should contain the full JSON of your token.json (from a working local run)
          echo '${{ secrets.TOKEN_JSON }}' > token.json
          echo "OAuth files created successfully."

      # ðŸŒŸ CHANGE 2: Updated the run command to a more robust script execution format
      - name: Run Weather Blog Bot
        run: |
          # Assuming the script is located at src/main.py based on your previous command.
          # We use direct path execution for better script portability and clarity.
          python src/main.py

      # ðŸŒŸ CRITICAL FOR ROTATION: Commit the state file back to the repository
      - name: Commit and Push State File
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          # This specifies the file updated by your Python script (main.py)
          file_pattern: 'last_posted_zone.txt'
          commit_message: 'ðŸ¤– BOT: Update zone rotation state after successful post.'
          skip_dirty_check: true

      # Optional: upload generated HTML posts & index as workflow artifacts
      - name: Upload generated posts as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: generated-posts
          path: output_posts