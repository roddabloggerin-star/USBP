name: run_weather_bot

on:
  # Run 5 times a day at 00:00, 04:00, 08:00, 13:00, and 17:00 UTC.
  # This schedule divides the day into roughly 4-5 hour intervals for high-frequency posting.
  schedule:
    - cron: "0 0,4,8,13,17 * * *"
  # Allow manual runs for testing
  workflow_dispatch:

jobs:
  run_weather_bot:
    runs-on: ubuntu-latest

    env:
      # Secrets (all stored in GitHub repo settings â†’ Secrets and variables â†’ Actions)
      NWS_USER_AGENT: ${{ secrets.NWS_USER_AGENT }}
      BLOG_ID: ${{ secrets.BLOG_ID }}               # required only when PUBLISH=true
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      BLOGGER_API_KEY: ${{ secrets.BLOGGER_API_KEY }} 
      BLOG_BASE_URL: ${{ secrets.BLOG_BASE_URL }}     # e.g. https://usa-weather-updates.blogspot.com

      # File paths used by the code (Updated to bot_state.json)
      CLIENT_SECRETS_FILE: client_secrets.json
      STATE_FILE: bot_state.json # <--- UPDATED STATE FILE NAME

      # MASTER SWITCH: set this secret to "false" for testing; "true" for real publishing
      PUBLISH: ${{ secrets.PUBLISH }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          # Install all necessary dependencies including Google AI SDK and Blogger client
          pip install google-genai google-api-python-client google-auth-oauthlib python-dotenv requests aiohttp pandas pytrends python-dateutil

      # Create OAuth files from secrets
      - name: Create OAuth files from secrets
        run: |
          echo "Creating OAuth files from secrets..."
          # CLIENT_SECRETS_JSON should contain the full JSON of your client_secrets.json
          echo '${{ secrets.CLIENT_SECRETS_JSON }}' > client_secrets.json
          # TOKEN_JSON should contain the full JSON of your token.json (from a working local run)
          echo '${{ secrets.TOKEN_JSON }}' > token.json
          echo "OAuth files created successfully."

      # Run the main script
      - name: Run Weather Blog Bot
        run: |
          # We use direct path execution for better script portability and clarity.
          python main.py # Ensure this path is correct if your file is in the root directory

      # ðŸŒŸ CRITICAL CHANGE: Commit the state file back to the repository
      - name: Commit and Push State File
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          # This specifies the file updated by your Python script (main.py)
          file_pattern: 'bot_state.json' # <--- UPDATED FILE PATTERN
          commit_message: 'ðŸ¤– BOT: Update bot state after successful run.'
          skip_dirty_check: true

      # Optional: upload generated HTML posts & index as workflow artifacts
      - name: Upload generated posts as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: generated-posts
          path: output_posts