# .github/workflows/main.yml

name: ðŸŒ¦ï¸ Weather Blog Bot Runner
on:
  schedule:
    - cron: '0 0 * * *' 
  workflow_dispatch:

jobs:
  run_weather_bot:
    runs-on: ubuntu-latest
    
    # 1. Update the env block to include GEMINI_API_KEY
    env:
      NWS_USER_AGENT: ${{ secrets.NWS_USER_AGENT }}
      BLOG_ID: ${{ secrets.BLOG_ID }}
      # NEW: Required for the content generator
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }} 
      # The script looks for client_secrets.json at the root
      CLIENT_SECRETS_FILE: client_secrets.json 

    steps:
    - name: â¬‡ï¸ Checkout Repository
      uses: actions/checkout@v4

    # ----------------------------------------------------
    # 2. NEW STEP: Set up Python
    # This step configures the runner with the correct Python version.
    - name: ðŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12' # Specify a modern Python version

    # 3. NEW STEP: Install Dependencies (Fixes the "No module named 'dotenv'" error)
    # This step installs all necessary libraries, assuming a requirements.txt file exists.
    - name: ðŸ“¦ Install Dependencies
      run: |
        # Install the Google GenAI SDK, Requests, python-dotenv, and Google Auth libraries
        pip install -r requirements.txt
    # ----------------------------------------------------

    # 4. Create the OAuth files from the secrets
    - name: ðŸ“ Create OAuth Token and Secrets Files
      run: |
        echo "Creating OAuth files from secrets..."
        
        # Create client_secrets.json (used by the script)
        # Note: '***' in the log means the actual secret value is masked
        echo '${{ secrets.BLOGGER_CLIENT_SECRETS_JSON }}' > client_secrets.json
        
        # Create token.json (contains the refresh token)
        echo '${{ secrets.BLOGGER_TOKEN_JSON }}' > token.json
        
        echo "OAuth files created successfully."

    # 5. Execute the Main Python Script
    - name: ðŸš€ Run Weather Bot
      # The python environment is now correctly set up and dependencies are installed
      run: python -m src.main